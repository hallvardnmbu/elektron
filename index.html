<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>elektron</title>
    <style>
        @font-face {
            font-family: 'JetBrainsMono';
            src: url('/fonts/Regular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'JetBrainsMono';
            src: url('/fonts/Bold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'JetBrainsMono';
            src: url('/fonts/Light.woff2') format('woff2');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            border-radius: 0 !important;
        }

        html, body {
            height: 100%;
            font-family: 'JetBrainsMono', 'JetBrains Mono', 'Courier New', monospace;
            background: #ffffff;
            color: #1D1C1A;
            line-height: 1.2;
            font-size: 14px;
            font-weight: 400;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        #header {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #1D1C1A;
            border-left: 2px solid #1D1C1A;
            border-right: 2px solid #1D1C1A;
            padding: 10px;
            width: 100%;
            max-width: 800px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #dateNavigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #ffffff;
            font-weight: 700;
            max-width: 800px;
            width: 100%;
        }

        .nav-button {
            background: #ffffff;
            border: 2px solid #1D1C1A;
            color: #1D1C1A;
            padding: 5px;
            font-family: 'JetBrainsMono', monospace;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            border-radius: 0 !important;
        }

        .nav-button:hover {
            background: #1D1C1A;
            color: #ffffff;
        }

        .nav-button:disabled {
            background: #ffffff;
            color: #cccccc;
            border-color: #cccccc;
            cursor: not-allowed;
        }

        .nav-button:disabled:hover {
            background: #ffffff;
            color: #cccccc;
        }

        #currentDate {
            font-weight: 700;
            letter-spacing: 1px;
            min-width: 120px;
            text-align: center;
        }

        #thresholdControls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 15px 0 0 0;
            padding: 10px;
            border: 2px solid #1D1C1A;
            background: #ffffff;
            font-weight: 700;
            max-width: 800px;
            width: 100%;
            flex-wrap: wrap;
            box-sizing: border-box;
        }

        .threshold-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-family: 'JetBrainsMono', monospace;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
        }

        .threshold-checkbox input[type="checkbox"] {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #1D1C1A;
            background: #ffffff;
            cursor: pointer;
            position: relative;
        }

        .threshold-checkbox input[type="checkbox"]:checked {
            background: #1D1C1A;
        }

        .threshold-checkbox input[type="checkbox"]:checked::after {
            position: absolute;
            top: -2px;
            left: 2px;
            color: #ffffff;
            font-weight: bold;
            font-size: 12px;
        }

        .threshold-zero { color: #CC0000; }
        .threshold-fifty { color: #008E00; }
        .threshold-ninety { color: #CC0000; }

        #regionSelector {
            display: inline-block;
        }

        .region-dropdown {
            background: #ffffff;
            border: 2px solid #1D1C1A;
            color: #1D1C1A;
            padding: 2px 6px;
            font-family: 'JetBrainsMono', monospace;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            border-radius: 0 !important;
            appearance: none;
        }

        .region-dropdown:focus {
            outline: none;
            background: #1D1C1A;
            color: #ffffff;
        }

        .region-dropdown option {
            background: #ffffff;
            color: #1D1C1A;
            font-family: 'JetBrainsMono', monospace;
            font-weight: 700;
        }

        #graphContainer {
            width: 100%;
            max-width: 800px;
            height: 400px;
            margin: 0;
            border: 2px solid #1D1C1A;
            border-top: 10px solid #1D1C1A;
            border-bottom: 10px solid #1D1C1A;
            background: #ffffff;
            position: relative;
            box-sizing: border-box;
        }

        #priceGraph {
            width: 100%;
            height: 100%;
            display: block;
        }

        #statistics {
            font-weight: 700;
            font-size: 12px;
            margin-top: 0;
            letter-spacing: 1px;
            border: 2px solid #1D1C1A;
            padding: 10px;
            background: #ffffff;
            min-width: 300px;
            max-width: 800px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .error {
            border: 2px solid #1D1C1A;
            background: #ffffff;
            color: #1D1C1A;
            padding: 10px;
            margin: 20px 0;
            font-weight: 700;
            text-align: center;
            max-width: 600px;
            width: 100%;
        }

        /* Ensure no corner radii anywhere */
        *, *::before, *::after {
            border-radius: 0 !important;
        }

        /* Loading state */
        .loading {
            font-weight: 300;
            text-align: center;
            padding: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            #header {
                font-size: 14px;
                margin-bottom: 15px;
            }
            
            #graphContainer {
                height: 300px;
                margin: 15px 0;
            }
            
            #statistics {
                font-size: 14px;
                padding: 10px;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <span id="headerTitle">Strømpriser (øre/kWh) i</span>
        <span id="regionSelector">
            <select class="region-dropdown" id="regionDropdown">
                <option value="NO1">NO1</option>
                <option value="NO2" selected>NO2</option>
                <option value="NO3">NO3</option>
                <option value="NO4">NO4</option>
                <option value="NO5">NO5</option>
            </select>
        </span>
    </div>
    
    <div id="dateNavigation" style="display: none;">
        <button class="nav-button" id="prevButton">◀ Forrige</button>
        <div id="currentDate"></div>
        <button class="nav-button" id="nextButton">Neste ▶</button>
    </div>
    
    <div id="thresholdControls" style="display: none;">
        <label class="threshold-checkbox threshold-zero">
            <input type="checkbox" id="threshold0" />
            <span>0 øre</span>
        </label>
        <label class="threshold-checkbox threshold-fifty">
            <input type="checkbox" id="threshold50" />
            <span>Norgespris</span>
        </label>
        <label class="threshold-checkbox threshold-ninety">
            <input type="checkbox" id="threshold75" />
            <span>75 øre</span>
        </label>
    </div>
    
    <div class="loading" id="loading">Laster laster laster...</div>

    <div id="graphContainer" style="display: none;">
        <canvas id="priceGraph"></canvas>
    </div>

    <div id="error" class="error" style="display: none;"></div>
    <div id="statistics" style="display: none;"></div>

    <script>
        let chartData = null;
        let currentDate = new Date();
        let currentRegion = 'NO2';
        let thresholdStates = {
            zero: true,
            fifty: true,
            seventyFive: true
        };

        // dataObject is expected to be the full chartData array here.
        function graphPrice(dataObject, targetDate = null) {
            const canvas = document.getElementById('priceGraph');
            const ctx = canvas.getContext('2d');

            const parent = canvas.parentElement;
            const dpr = window.devicePixelRatio || 1;
            canvas.width = parent.clientWidth * dpr;
            canvas.height = parent.clientHeight * dpr;
            ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transform before scaling
            ctx.scale(dpr, dpr);

            // Use the target date or fall back to today
            const dateToUse = targetDate || new Date();
            const offset = dateToUse.getTimezoneOffset();
            const adjustedDate = new Date(dateToUse.getTime() - offset * 60 * 1000);
            const dateString = adjustedDate.toISOString().split('T')[0];

            // Filter the data for the specified date and prepare price and hour arrays
            let dailyData = dataObject.filter(item => item.time.startsWith(dateString));
            if (dailyData.length === 0) {
                ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
                ctx.font = '14px JetBrainsMono, "JetBrains Mono", monospace';
                ctx.fillStyle = '#1D1C1A';
                ctx.textAlign = 'center';
                ctx.fillText('Hmm. Ingen data.', canvas.width / dpr / 2, canvas.height / dpr / 2);
                
                // Remove any existing hover functionality for no data case
                canvas.onmousemove = null;
                canvas.onmouseleave = null;
                return;
            }

            // Step graph: add a final point at last hour + 1 with the same value and correct hour label
            let stepData = dailyData.map(item => ({ hour: item.hour, price: item.price }));
            const last = stepData[stepData.length - 1];
            // Add a new hour label for the last value
            stepData.push({ hour: last.hour + 1, price: last.price });

            const prices = stepData.map(item => item.price);
            const hours = stepData.map(item => item.hour);

            const margin = { top: 30, right: 30, bottom: 40, left: 60 };
            const graphWidth = canvas.width / dpr - margin.left - margin.right;
            const graphHeight = canvas.height / dpr - margin.top - margin.bottom;

            const maxPrice = Math.max(...prices);
            const minPrice = Math.min(...prices);
            const priceRange = maxPrice - minPrice;
            const paddedMax = maxPrice + (priceRange * 0.1);
            const paddedMin = minPrice - (priceRange * 0.1);

            ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
            ctx.font = '12px JetBrainsMono, "JetBrains Mono", monospace';
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';

            // Draw Y-axis labels
            const yAxisTicks = 6;
            for (let i = 0; i <= yAxisTicks; i++) {
                const value = paddedMin + (paddedMax - paddedMin) * i / yAxisTicks;
                const y = margin.top + graphHeight - (graphHeight * i / yAxisTicks);
                
                // Y-axis labels
                ctx.fillText(value.toFixed(1), margin.left - 10, y);
            }

            // Draw X-axis labels with responsive spacing
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            const xTickDenominator = stepData.length - 1 > 0 ? stepData.length - 1 : 1;
            
            // Calculate if there's enough space for all hour labels
            ctx.font = '12px JetBrainsMono, "JetBrains Mono", monospace';
            const sampleText = '00';
            const labelWidth = ctx.measureText(sampleText).width;
            const minLabelSpacing = labelWidth + 10; // Add some padding
            const availableSpacing = graphWidth / (stepData.length - 1);
            
            // Determine label step based on actual space availability
            let labelStep = 1;
            if (availableSpacing < minLabelSpacing) {
                if (availableSpacing < minLabelSpacing / 2) {
                    labelStep = 4; // Show every 4th hour when very cramped
                } else {
                    labelStep = 2; // Show every 2nd hour when somewhat cramped
                }
            }
            
            for (let i = 0; i < stepData.length; i++) {
                const x = margin.left + (graphWidth / xTickDenominator) * i;
                
                // X-axis labels - only show at specified intervals
                if (i % labelStep === 0 || i === stepData.length - 1) {
                    ctx.fillText(hours[i].toString().padStart(2, '0'), x, margin.top + graphHeight + 10);
                }
            }

            // Draw step price line
            for (let i = 0; i < stepData.length - 1; i++) {
                const x1 = margin.left + (graphWidth / xTickDenominator) * i;
                const x2 = margin.left + (graphWidth / xTickDenominator) * (i + 1);
                const y1 = margin.top + graphHeight - ((stepData[i].price - paddedMin) / (paddedMax - paddedMin)) * graphHeight;
                const y2 = margin.top + graphHeight - ((stepData[i + 1].price - paddedMin) / (paddedMax - paddedMin)) * graphHeight;
                
                const lineColor = '#1D1C1A';
                
                ctx.beginPath();
                // Draw horizontal line for current step
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y1);
                // Draw vertical line to next step level
                ctx.lineTo(x2, y2);
                ctx.strokeStyle = lineColor;
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // Draw threshold lines
            drawThresholdLines(ctx, margin, graphWidth, graphHeight, paddedMin, paddedMax);

            // --- Hover Functionality ---
            const hoverLayerId = 'priceGraph-hover';
            let existingHoverLayer = document.getElementById(hoverLayerId);
            if (existingHoverLayer) {
                existingHoverLayer.remove();
            }

            let hoverLayer = document.createElement('canvas');
            hoverLayer.id = hoverLayerId;
            hoverLayer.style.position = "absolute";
            hoverLayer.style.left = canvas.offsetLeft + "px";
            hoverLayer.style.top = canvas.offsetTop + "px";
            hoverLayer.width = canvas.width;
            hoverLayer.height = canvas.height;
            hoverLayer.style.width = canvas.width / dpr + "px";
            hoverLayer.style.height = canvas.height / dpr + "px";
            hoverLayer.style.pointerEvents = "none";
            canvas.parentElement.appendChild(hoverLayer);
            let hoverCtx = hoverLayer.getContext("2d");
            hoverCtx.setTransform(1, 0, 0, 1, 0, 0);
            hoverCtx.scale(dpr, dpr);

            canvas.onmousemove = function(event) {
                if (stepData.length < 2) return;
                const rect = canvas.getBoundingClientRect();
                const x = (event.clientX - rect.left) * (canvas.width / dpr / rect.width);
                const xScale = graphWidth / xTickDenominator;
                let hoverIndex = Math.floor((x - margin.left) / xScale);
                if (hoverIndex < 0) hoverIndex = 0;
                if (hoverIndex >= stepData.length - 1) hoverIndex = stepData.length - 2;
                const price = stepData[hoverIndex].price;
                const hour = hours[hoverIndex];
                const xStep = margin.left + xScale * hoverIndex;
                const yStep = margin.top + graphHeight - ((price - paddedMin) / (paddedMax - paddedMin)) * graphHeight;

                hoverCtx.clearRect(0, 0, hoverLayer.width / dpr, hoverLayer.height / dpr);
                hoverCtx.font = '12px JetBrainsMono, "JetBrains Mono", monospace';
                hoverCtx.fillStyle = '#1D1C1A';
                hoverCtx.textAlign = 'left';

                // Tooltip
                const text = hour.toString().padStart(2, '0') + ':00 - ' + price.toFixed(1) + ' øre';
                const textMetrics = hoverCtx.measureText(text);
                let textX = xStep + 10;
                let textY = yStep - 15;
                
                if (textX + textMetrics.width > canvas.width / dpr - 10) {
                    textX = xStep - textMetrics.width - 10;
                }
                if (textY < 20) {
                    textY = yStep + 25;
                }
                
                // Tooltip background
                hoverCtx.fillStyle = '#ffffff';
                hoverCtx.fillRect(textX - 5, textY - 15, textMetrics.width + 10, 20);
                hoverCtx.strokeStyle = '#1D1C1A';
                hoverCtx.lineWidth = 2;
                hoverCtx.strokeRect(textX - 5, textY - 15, textMetrics.width + 10, 20);
                
                // Tooltip text
                hoverCtx.fillStyle = '#1D1C1A';
                hoverCtx.fillText(text, textX, textY);

                // Vertical line
                hoverCtx.beginPath();
                hoverCtx.moveTo(xStep, margin.top);
                hoverCtx.lineTo(xStep, margin.top + graphHeight);
                hoverCtx.strokeStyle = '#1D1C1A';
                hoverCtx.lineWidth = 2;
                hoverCtx.stroke();
                
                // Point marker
                hoverCtx.beginPath();
                hoverCtx.arc(xStep, yStep, 4, 0, 2 * Math.PI);
                hoverCtx.fillStyle = '#1D1C1A';
                hoverCtx.fill();
            };

            canvas.onmouseleave = function() {
                hoverCtx.clearRect(0, 0, hoverLayer.width / dpr, hoverLayer.height / dpr);
            };
        }

        function drawThresholdLines(ctx, margin, graphWidth, graphHeight, paddedMin, paddedMax) {
            const thresholds = [
                { value: 0, name: '0 øre', color: '#CC0000', enabled: thresholdStates.zero },
                { value: 50, name: 'Norgespris', color: '#008E00', enabled: thresholdStates.fifty },
                { value: 75, name: '75 øre', color: '#CC0000', enabled: thresholdStates.seventyFive }
            ];

            thresholds.forEach(threshold => {
                if (threshold.enabled && threshold.value >= paddedMin && threshold.value <= paddedMax) {
                    const y = margin.top + graphHeight - ((threshold.value - paddedMin) / (paddedMax - paddedMin)) * graphHeight;
                    
                    ctx.beginPath();
                    ctx.moveTo(margin.left, y);
                    ctx.lineTo(margin.left + graphWidth, y);
                    ctx.strokeStyle = threshold.color;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // Add threshold label
                    ctx.font = '11px JetBrainsMono, "JetBrains Mono", monospace';
                    ctx.fillStyle = threshold.color;
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(threshold.name, margin.left + 5, y - 10);
                }
            });
        }

        function updateThresholdStates() {
            thresholdStates.zero = document.getElementById('threshold0').checked;
            thresholdStates.fifty = document.getElementById('threshold50').checked;
            thresholdStates.seventyFive = document.getElementById('threshold75').checked;
            
            if (chartData) {
                graphPrice(chartData, currentDate);
            }
        }

        function updateRegion() {
            currentRegion = document.getElementById('regionDropdown').value;
            loadData(currentDate);
        }

        async function loadData(date = null) {
            const error = document.getElementById('error');
            const statistics = document.getElementById('statistics');
            const loading = document.getElementById('loading');
            const graphContainer = document.getElementById('graphContainer');
            const dateNavigation = document.getElementById('dateNavigation');
            const thresholdControls = document.getElementById('thresholdControls');

            error.style.display = 'none';
            statistics.style.display = 'none';
            loading.style.display = 'block';
            graphContainer.style.display = 'none';
            thresholdControls.style.display = 'none';

            try {
                let url = '/prices';
                if (date) {
                    url = '/prices/' + date.getFullYear() + '/' + (date.getMonth() + 1) + '/' + date.getDate() + '/' + currentRegion;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Er du i fremtiden?");
                }

                const priceData = await response.json();

                if (priceData.length === 0) {
                    throw new Error('Hmm. Ingen data.');
                }

                loading.style.display = 'none';
                displayData(priceData, date);
                graphContainer.style.display = 'block';
                statistics.style.display = 'flex';
                dateNavigation.style.display = 'flex';
                thresholdControls.style.display = 'flex';

                chartData = priceData;
                setTimeout(() => graphPrice(chartData, date), 100); // Allow DOM to update

            } catch (err) {
                loading.style.display = 'none';
                error.textContent = err.message;
                error.style.display = 'block';
            }
        }

        function displayData(priceData, date = null) {
            const prices = priceData.map(item => item.price);
            const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
            const maxPrice = Math.max(...prices);
            const minPrice = Math.min(...prices);

            const displayDate = date || new Date();
            const dateStr = displayDate.getDate().toString().padStart(2, '0') + '-' +
                        (displayDate.getMonth() + 1).toString().padStart(2, '0') + '-' +
                        displayDate.getFullYear();
            const headerTitle = 'Strømpriser (øre/kWh) den ' + dateStr + ' i';
            document.getElementById('headerTitle').textContent = headerTitle;

            const statisticsElement = document.getElementById('statistics');
            statisticsElement.innerHTML = 
                '<span>Min.: ' + minPrice.toFixed(1) + '</span>' +
                '<span>Gjn.: ' + avgPrice.toFixed(1) + '</span>' +
                '<span>Maks: ' + maxPrice.toFixed(1) + '</span>';

            // Update date navigation
            document.getElementById('currentDate').textContent = dateStr;
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const minDate = new Date('2020-01-01');
            
            // Enable/disable previous button
            const prevDate = new Date(currentDate);
            prevDate.setDate(prevDate.getDate() - 1);
            prevButton.disabled = prevDate < minDate;
            
            // Enable/disable next button (can go to tomorrow but not beyond)
            const nextDate = new Date(currentDate);
            nextDate.setDate(nextDate.getDate() + 1);
            nextButton.disabled = nextDate > tomorrow;
        }

        function navigateDate(direction) {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + direction);
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = new Date('2020-01-01');
            
            if (newDate >= minDate && newDate <= tomorrow) {
                currentDate = newDate;
                loadData(currentDate);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for navigation buttons
            document.getElementById('prevButton').addEventListener('click', () => navigateDate(-1));
            document.getElementById('nextButton').addEventListener('click', () => navigateDate(1));
            
            // Add event listeners for threshold checkboxes
            document.getElementById('threshold0').addEventListener('change', updateThresholdStates);
            document.getElementById('threshold50').addEventListener('change', updateThresholdStates);
            document.getElementById('threshold75').addEventListener('change', updateThresholdStates);
            
            // Add event listener for region dropdown
            document.getElementById('regionDropdown').addEventListener('change', updateRegion);
            
            // Set default checkbox states
            document.getElementById('threshold0').checked = true;
            document.getElementById('threshold50').checked = true;
            document.getElementById('threshold75').checked = true;
            
            loadData();
        });

        window.addEventListener('resize', function() {
            if (chartData) {
                setTimeout(() => graphPrice(chartData, currentDate), 100);
            }
        });
    </script>
</body>
</html> 